<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flexi Visitor Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700;800;900&family=Barlow:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-red: #DC2626;
            --dark-bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --border: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --hover-bg: #252525;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            color: var(--text-primary);
            font-family: 'Barlow Condensed', 'Arial Narrow', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /*
            SCALE-TO-FIT APPROACH:
            The inner canvas is always 1920Ã—1080.
            JS calculates the correct scale to fit whatever screen
            the stick reports, and applies it via transform.
            This works on any resolution or overscan situation.
        */
        #canvas {
            width: 1920px;
            height: 1080px;
            transform-origin: top left;
            position: absolute;
            top: 0;
            left: 0;
            background: #000;
        }

        /* â”€â”€ SHELL â”€â”€ */
        .shell {
            width: 1920px;
            height: 1080px;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 10px;
            overflow: hidden;
        }

        /* â”€â”€ HEADER â”€â”€ */
        .header {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 28px;
            border-left: 4px solid var(--primary-red);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-logo { height: 42px; width: auto; object-fit: contain; }

        .header-title {
            font-size: 32px;
            font-weight: 400;
            letter-spacing: -1.5px;
            text-transform: uppercase;
            line-height: 1;
        }

        .header-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 3px;
        }

        .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }

        .header-time {
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--primary-red);
            line-height: 1;
        }

        .header-date {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .version-badge {
            display: inline-block;
            padding: 5px 16px;
            background: rgba(220,38,38,0.15);
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 999px;
            color: var(--primary-red);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        /* â”€â”€ STATS â”€â”€ */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            flex-shrink: 0;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 22px;
        }

        .stat-value {
            font-size: 48px;
            font-weight: 900;
            color: var(--primary-red);
            letter-spacing: -3px;
            line-height: 1;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        /* â”€â”€ BODY â”€â”€ */
        .body {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 10px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* â”€â”€ VISITORS PANEL â”€â”€ */
        .visitors-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            border-left: 4px solid var(--primary-red);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .panel-header {
            padding: 11px 20px 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .live-dot {
            width: 8px; height: 8px;
            background: var(--primary-red);
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(220,38,38,0.6);
            animation: blink 1.4s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.2; }
        }

        .visitors-list {
            flex: 1;
            overflow: hidden;
            padding: 10px 14px;
            display: flex;
            flex-direction: column;
            gap: 7px;
        }

        .visitor-row {
            background: var(--dark-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 11px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 14px;
            flex-shrink: 0;
            animation: rowIn 0.35s ease-out both;
        }

        @keyframes rowIn {
            from { opacity: 0; transform: translateX(-10px); }
            to   { opacity: 1; transform: translateX(0); }
        }

        .visitor-name {
            font-size: 20px;
            font-weight: 900;
            color: var(--primary-red);
            letter-spacing: -0.3px;
            margin-bottom: 3px;
            line-height: 1;
        }

        .visitor-meta {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .visitor-meta span { color: var(--text-primary); }

        .onsite-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(34,197,94,0.15);
            border: 1px solid rgba(34,197,94,0.35);
            border-radius: 5px;
            color: #4ade80;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .empty-state { text-align: center; padding: 50px 20px; color: #555; }
        .empty-state-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.3; }
        .empty-state-text { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        .loading-state { text-align: center; padding: 50px 20px; color: var(--text-secondary); }
        .spinner {
            border: 3px solid rgba(220,38,38,0.2);
            border-top: 3px solid var(--primary-red);
            border-radius: 50%;
            width: 34px; height: 34px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }

        .error-state {
            background: rgba(220,38,38,0.1);
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 8px;
            padding: 14px 18px;
            margin: 6px;
        }
        .error-title { font-size: 14px; font-weight: 800; color: var(--primary-red); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .error-detail { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }

        /* â”€â”€ RIGHT COLUMN â”€â”€ */
        .right-col {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            overflow: hidden;
        }

        .hs-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            border-left: 4px solid var(--primary-red);
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .hs-body {
            padding: 10px 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-height: 0;
        }

        .hs-metric {
            background: var(--dark-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .hs-metric-value {
            font-size: 38px;
            font-weight: 900;
            color: var(--primary-red);
            letter-spacing: -2px;
            line-height: 1;
            margin-bottom: 3px;
        }

        .hs-metric-value.green { color: #4ade80; }

        .hs-metric-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .wifi-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            border-left: 4px solid var(--primary-red);
            padding: 14px 18px;
            flex-shrink: 0;
        }

        .card-title { font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: -0.5px; margin-bottom: 12px; }
        .wifi-row { margin-bottom: 9px; }
        .wifi-row:last-child { margin-bottom: 0; }
        .wifi-row-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1px; }
        .wifi-row-value { font-size: 15px; font-weight: 700; color: var(--text-primary); }
        .wifi-password-value { font-size: 15px; font-weight: 800; color: var(--primary-red); letter-spacing: 0.5px; }
        .access-ok { font-size: 15px; font-weight: 700; color: #4ade80; }

        /* â”€â”€ DEBUG â”€â”€ */
        .debug-banner {
            position: fixed;
            bottom: 10px; left: 10px; right: 10px;
            background: rgba(30,30,30,0.97);
            border: 1px solid var(--primary-red);
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 700;
            z-index: 50000;
            display: none;
            color: #fff;
        }
        .debug-banner.show { display: block; }

        /* â”€â”€ OVERLAYS â”€â”€ */
        .welcome-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center; justify-content: center;
            z-index: 10000;
        }
        .welcome-overlay.show { display: flex; }

        .welcome-box {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            border-left: 6px solid var(--primary-red);
            padding: 70px 100px;
            text-align: center;
            animation: modalSlideIn 0.4s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .welcome-eyebrow { font-size: 16px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; }
        .welcome-heading { font-size: 96px; font-weight: 900; letter-spacing: -4px; text-transform: uppercase; line-height: 1; margin-bottom: 20px; }
        .welcome-name { font-size: 56px; font-weight: 800; color: var(--primary-red); letter-spacing: -2px; text-transform: uppercase; margin-bottom: 24px; }
        .welcome-sub { font-size: 18px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .video-overlay {
            position: fixed; inset: 0; background: #000;
            display: none; align-items: center; justify-content: center;
            z-index: 100000;
        }
        .video-overlay.show { display: flex; }
        .video-overlay iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

<div id="canvas">
<div class="shell">

    <div class="header">
        <div class="header-left">
            <img src="https://narrowaisleservice.github.io/Flexi-Parts-System/flexi-logo-white.svg"
                 alt="Flexi Logo" class="header-logo" onerror="this.style.display='none'">
            <div>
                <div class="header-title">Visitor Dashboard</div>
                <div class="header-subtitle">Reception â€” Live View</div>
            </div>
        </div>
        <div><div class="version-badge">V â€” 330</div></div>
        <div class="header-right">
            <div class="header-time" id="time">00:00:00</div>
            <div class="header-date" id="date">Loading...</div>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-value" id="todayCount">0</div>
            <div class="stat-label">Visitors Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="currentCount">0</div>
            <div class="stat-label">Currently On-Site</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="weekCount">0</div>
            <div class="stat-label">This Week</div>
        </div>
    </div>

    <div class="body">
        <div class="visitors-panel">
            <div class="panel-header">
                <div class="panel-title">Current Visitors On-Site</div>
                <div class="live-indicator">
                    <div class="live-dot"></div>Live
                </div>
            </div>
            <div class="visitors-list" id="visitorsList">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading Visitors...</div>
                </div>
            </div>
        </div>

        <div class="right-col">
            <div class="hs-card">
                <div class="panel-header">
                    <div class="panel-title">Health &amp; Safety</div>
                </div>
                <div class="hs-body">
                    <div class="hs-metric">
                        <div class="hs-metric-value green" id="daysSinceAccident">â€”</div>
                        <div class="hs-metric-label">Days Since Last Accident</div>
                    </div>
                    <div class="hs-metric">
                        <div class="hs-metric-value" id="currentMonthAccidents">â€”</div>
                        <div class="hs-metric-label">Accidents This Month</div>
                    </div>
                    <div class="hs-metric">
                        <div class="hs-metric-value" id="ytdAccidents">â€”</div>
                        <div class="hs-metric-label">Year to Date</div>
                    </div>
                </div>
            </div>

            <div class="wifi-card">
                <div class="card-title">Guest WiFi</div>
                <div class="wifi-row">
                    <div class="wifi-row-label">Network Name</div>
                    <div class="wifi-row-value">Flexi Guest Network</div>
                </div>
                <div class="wifi-row">
                    <div class="wifi-row-label">Password</div>
                    <div class="wifi-password-value">$Building564Free$</div>
                </div>
                <div class="wifi-row">
                    <div class="wifi-row-label">Access</div>
                    <div class="access-ok">Internet Â· Guests Only</div>
                </div>
            </div>
        </div>
    </div>

</div><!-- /.shell -->
</div><!-- /#canvas -->

<div class="debug-banner" id="debugBanner"></div>

<div class="welcome-overlay" id="welcomeOverlay">
    <div class="welcome-box">
        <div class="welcome-eyebrow">Flexi â€” Narrow Aisle Ltd</div>
        <div class="welcome-heading">Welcome</div>
        <div class="welcome-name" id="welcomeVisitorName"></div>
        <div class="welcome-sub">Please collect your visitor badge from reception</div>
    </div>
</div>

<div class="video-overlay" id="videoOverlay">
    <iframe id="youtubeVideo" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>

<script>
    /* â”€â”€â”€ SCALE TO FIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       The canvas is always 1920Ã—1080.
       This function works out what scale fits the actual screen,
       centres it, and applies it â€” handles any TV/stick resolution
       and any amount of overscan automatically.
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function scaleCanvas() {
        var canvas  = document.getElementById('canvas');
        var scaleX  = window.innerWidth  / 1920;
        var scaleY  = window.innerHeight / 1080;
        var scale   = Math.min(scaleX, scaleY);
        var offsetX = (window.innerWidth  - 1920 * scale) / 2;
        var offsetY = (window.innerHeight - 1080 * scale) / 2;
        canvas.style.transform = 'translate(' + offsetX + 'px, ' + offsetY + 'px) scale(' + scale + ')';
    }

    scaleCanvas();
    window.addEventListener('resize', scaleCanvas);

    /* â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyI8cHuRpKec2e28byX8tz85Z09Ze0TGebnugkD7uC2hg6bfWYvP9dKHZLGvrCje0B5aA/exec';

    var lastVisitorIds    = {};
    var consecutiveErrors = 0;
    var lastSuccessfulLoad = null;

    /* â”€â”€â”€ HTTP GET â€” fetch with XHR fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function httpGet(url) {
        return new Promise(function(resolve, reject) {
            if (typeof fetch === 'function') {
                var ctrl = new AbortController();
                var tid  = setTimeout(function() { ctrl.abort(); }, 15000);
                fetch(url, { method: 'GET', signal: ctrl.signal })
                    .then(function(r) { clearTimeout(tid); return r.text(); })
                    .then(resolve)
                    .catch(function() { clearTimeout(tid); xhrGet(url, resolve, reject); });
            } else {
                xhrGet(url, resolve, reject);
            }
        });
    }

    function xhrGet(url, resolve, reject) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.timeout = 15000;
        xhr.onload  = function() {
            if (xhr.status >= 200 && xhr.status < 300) { resolve(xhr.responseText); }
            else { reject(new Error('HTTP ' + xhr.status)); }
        };
        xhr.onerror   = function() { reject(new Error('XHR network error')); };
        xhr.ontimeout = function() { reject(new Error('Timeout')); };
        try { xhr.send(); } catch(e) { reject(e); }
    }

    function safeJSON(text) {
        if (!text) throw new Error('Empty response');
        return JSON.parse(text.replace(/^\s*\)\]\}'/, '').trim());
    }

    /* â”€â”€â”€ DEBUG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showDebug(msg, type) {
        var b = document.getElementById('debugBanner');
        b.textContent = '[' + new Date().toLocaleTimeString('en-GB') + '] ' + msg;
        b.classList.add('show');
        setTimeout(function() { b.classList.remove('show'); }, 7000);
        console.log('[' + (type || 'INFO') + '] ' + msg);
    }

    /* â”€â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function updateClock() {
        var now = new Date();
        document.getElementById('time').textContent = now.toLocaleTimeString('en-GB');
        document.getElementById('date').textContent = now.toLocaleDateString('en-GB', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
    }

    /* â”€â”€â”€ WELCOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showWelcome(name) {
        document.getElementById('welcomeVisitorName').textContent = name;
        var ov = document.getElementById('welcomeOverlay');
        ov.classList.add('show');
        setTimeout(function() { ov.classList.remove('show'); }, 12000);
    }

    /* â”€â”€â”€ ESCAPE HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function esc(s) {
        if (s == null) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* â”€â”€â”€ VISITORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadVisitors() {
        showDebug('Fetching visitors...', 'INFO');
        var today = new Date().toLocaleDateString('en-GB');
        var url   = GOOGLE_SCRIPT_URL + '?action=getTodaysVisitors&date=' + encodeURIComponent(today) + '&cache=' + Date.now();
        httpGet(url).then(function(text) {
            var visitors = safeJSON(text);
            consecutiveErrors  = 0;
            lastSuccessfulLoad = new Date();
            var signedIn = (visitors || []).filter(function(v) { return v.status === 'Signed In'; });
            document.getElementById('todayCount').textContent   = visitors ? visitors.length : 0;
            document.getElementById('currentCount').textContent = signedIn.length;

            signedIn.forEach(function(v) {
                var id = v.visitorName + '_' + v.timeIn;
                if (!lastVisitorIds[id]) showWelcome(v.visitorName);
            });
            lastVisitorIds = {};
            signedIn.forEach(function(v) { lastVisitorIds[v.visitorName + '_' + v.timeIn] = true; });

            var list = document.getElementById('visitorsList');
            if (signedIn.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“­</div><div class="empty-state-text">No visitors currently on-site</div></div>';
            } else {
                list.innerHTML = signedIn.map(function(v, i) {
                    return '<div class="visitor-row" style="animation-delay:' + (i * 0.07) + 's">'
                        + '<div><div class="visitor-name">' + esc(v.visitorName) + '</div>'
                        + '<div class="visitor-meta"><span>' + esc(v.companyName) + '</span>'
                        + ' &nbsp;Â·&nbsp; Host: <span>' + esc(v.hostName) + '</span>'
                        + ' &nbsp;Â·&nbsp; In: <span>' + esc(v.timeIn) + '</span></div></div>'
                        + '<div class="onsite-badge">On-Site</div></div>';
                }).join('');
            }
            showDebug('Loaded ' + signedIn.length + ' on-site visitor(s)', 'OK');
        }).catch(function(e) {
            consecutiveErrors++;
            var msg = e.message || 'Unknown error';
            showDebug('Error #' + consecutiveErrors + ': ' + msg, 'ERR');
            document.getElementById('visitorsList').innerHTML =
                '<div class="error-state"><div class="error-title">âš  Error #' + consecutiveErrors + '</div>'
                + '<div class="error-detail">' + esc(msg)
                + '<br>Last OK: ' + (lastSuccessfulLoad ? lastSuccessfulLoad.toLocaleTimeString('en-GB') : 'Never')
                + '<br>Retrying in 30sâ€¦</div></div>';
        });
    }

    /* â”€â”€â”€ HEALTH & SAFETY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadHealthSafety() {
        httpGet(GOOGLE_SCRIPT_URL + '?action=getHealthSafety&cache=' + Date.now())
        .then(function(text) {
            var d = safeJSON(text);
            document.getElementById('daysSinceAccident').textContent    = d.daysSinceAccident    != null ? d.daysSinceAccident    : '0';
            document.getElementById('currentMonthAccidents').textContent = d.currentMonthAccidents != null ? d.currentMonthAccidents : '0';
            document.getElementById('ytdAccidents').textContent          = d.ytdAccidents         != null ? d.ytdAccidents         : '0';
        }).catch(function() {
            ['daysSinceAccident','currentMonthAccidents','ytdAccidents'].forEach(function(id) {
                document.getElementById(id).textContent = 'â€”';
            });
        });
    }

    /* â”€â”€â”€ WEEK COUNT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadWeekVisitors() {
        httpGet(GOOGLE_SCRIPT_URL + '?action=getWeekVisitors&cache=' + Date.now())
        .then(function(text) {
            var d = safeJSON(text);
            document.getElementById('weekCount').textContent = d.count != null ? d.count : '0';
        }).catch(function() {
            document.getElementById('weekCount').textContent = 'â€”';
        });
    }

    /* â”€â”€â”€ VIDEO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /*
        YouTube Error 153 on Android sticks is caused by the iframe
        origin being blocked. Fix: use youtube-nocookie.com domain
        and add explicit feature flags. Also use the YouTube IFrame
        API to properly initialise the player rather than just
        setting a src directly.
    */
    var videoShowing = false;

    function showVideo() {
        if (videoShowing) return;
        videoShowing = true;
        var ov     = document.getElementById('videoOverlay');
        var iframe = document.getElementById('youtubeVideo');
        iframe.src = 'https://www.youtube-nocookie.com/embed/Jp79Byg1BAc'
                   + '?autoplay=1&mute=1&loop=1&playlist=Jp79Byg1BAc'
                   + '&controls=0&showinfo=0&modestbranding=1'
                   + '&rel=0&iv_load_policy=3&disablekb=1'
                   + '&origin=' + encodeURIComponent(window.location.origin);
        ov.classList.add('show');
        setTimeout(function() {
            ov.classList.remove('show');
            iframe.src = '';
            videoShowing = false;
        }, 60000);
    }

    /* â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    updateClock();
    loadVisitors();
    loadWeekVisitors();
    loadHealthSafety();

    setInterval(updateClock,       1000);
    setInterval(loadVisitors,     30000);
    setInterval(loadWeekVisitors, 60000);
    setInterval(loadHealthSafety, 60000);

    setTimeout(function() {
        showVideo();
        setInterval(showVideo, 120000);
    }, 15000);

    window.addEventListener('online',  function() { consecutiveErrors = 0; loadVisitors(); });
    window.addEventListener('offline', function() { showDebug('Network offline', 'ERR'); });
</script>
</body>
</html>
